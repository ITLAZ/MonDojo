<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Reserva</title>
    <link rel="stylesheet" href="../static/css/form-reserva.css">
    <script src="https://kit.fontawesome.com/9c32bf538b.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="navbar">
        <div class="nav-logo">
            <img src="../static/images/logo.png" alt="Monster Dojo">
        </div>
        <button class="menu-toggle" id="mobile-menu">
            <span class="fas fa-bars"></span>
        </button>
        <div class="navbar-right">
            <a href="/inicio_usuario">Home</a>
            <a href="#about">Sobre Nosotros</a>
            <a href="/food-menu">Menu</a>
            <a href="#order">Ubicaci√≥n</a>
            <a href="/game-menu">Productos</a>
            <a href="/user_reservations">Reservas</a>
            <a href="">Pedidos</a>
            <a href="/perfil_user"><i class="fas fa-user"></i></a>
            <a href="#" id="helpBtn"><i class="fas fa-question-circle"></i></a>
        </div>
    </div>
    <div class="container">
        <div class="form-section">
            <h2>Reservar una Mesa</h2>
            <form id="reservaForm" method="GET" action="/continuar_reserva">
                <div class="reservation-info">
                    <label for="date">Fecha</label>
                    <input type="date" id="date" name="date" required value="{{ fecha }}">
                    <label for="start_time">Hora de Inicio</label>
                    <input type="time" id="start_time" name="start_time" required value="{{ hora_inicio }}">
                    <label for="end_time">Hora de Fin</label>
                    <input type="time" id="end_time" name="end_time" required value="{{ hora_fin }}">
                </div>
                <button type="button" class="btn" id="continuarBtn">Continuar</button>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <ul class="flashes">
                            {% for category, message in messages %}
                                <li class="{{ category }}">{{ message }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}
            </form>
        </div>
    </div>

    <!-- Pop-up para confirmaci√≥n -->
    <div class="popup" id="confirmationPopup">
        <div class="popup-content">
            <span class="close-btn" onclick="closePopup()">&times;</span>
            <h2>Confirmar Reserva</h2>

            <!-- Mesas disponibles -->
            <div class="mesas-section">
                <h3>Mesas Disponibles</h3>
                <ul>
                    {% for mesa_info in mesas_disponibles %}
                    <li>
                        <input type="radio" name="mesa" class="mesa-radio" value="{{ mesa_info.mesa.id_mesa }}" {% if not mesa_info.disponible %}disabled{% endif %}>
                        Mesa {{ mesa_info.mesa.id_mesa }} - Capacidad: {{ mesa_info.mesa.capacidad }} - Ubicaci√≥n: {{ mesa_info.mesa.ubicacion }}
                        {% if not mesa_info.disponible %}
                        <span>(Disponible a partir de {{ mesa_info.proxima_disponibilidad.strftime('%H:%M') }})</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                <p id="mesa-error" style="color: red; display: none;">Selecciona una mesa</p>
            </div>

            <!-- Categor√≠as de productos y juegos -->
            <div class="categoria-section">
                <label for="categoria_productos">Categor√≠a de Productos</label>
                <select id="categoria_productos">
                    <option value="">Todas</option>
                    {% for categoria in categorias_productos %}
                    <option value="{{ categoria.id_catProducto }}">{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
                <label for="categoria_juegos">Categor√≠a de Juegos</label>
                <select id="categoria_juegos">
                    <option value="">Todos</option>
                    {% for categoria in categorias_juegos %}
                    <option value="{{ categoria.id_catJuego }}">{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Productos disponibles -->
            <div class="productos-section">
                <h3>Selecciona Productos</h3>
                <table id="productos-table">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Seleccionar</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                        <tr data-categoria="{{ producto.categoria_producto_id_catProducto }}">
                            <td><img src="{{ producto.imagen }}" alt="Imagen de {{ producto.nombre }}"></td>
                            <td><input type="checkbox" class="producto-checkbox" data-id="{{ producto.id_producto }}" data-precio="{{ producto.precio }}"></td>
                            <td>{{ producto.nombre }}</td>
                            <td>{{ producto.precio }}</td>
                            <td><input type="number" class="cantidad-producto" value="1" min="1"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Juegos disponibles -->
            <div class="juegos-section">
                <h3>Selecciona un Juego</h3>
                <table id="juegos-table">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Seleccionar</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for juego in juegos %}
                        <tr data-categoria="{{ juego.categoria_juego_id_catJuego }}">
                            <td><img src="{{ juego.imagen }}" alt="Imagen de {{ juego.nombre }}"></td>
                            <td><input type="radio" name="juego" class="juego-radio" data-id="{{ juego.id_juego }}" data-precio="{{ juego.precio_alquiler }}"></td>
                            <td>{{ juego.nombre }}</td>
                            <td>{{ juego.precio_alquiler }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Productos seleccionados -->
            <div class="productos-seleccionados-section">
                <h3>Productos Seleccionados</h3>
                <table id="productos-seleccionados-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div>Total: $<span id="total">0.00</span></div>
            </div>

            <form id="confirmarReservaForm" method="POST" action="/confirmar_reserva">
                <input type="hidden" name="date" value="{{ fecha }}">
                <input type="hidden" name="start_time" value="{{ hora_inicio }}">
                <input type="hidden" name="end_time" value="{{ hora_fin }}">
                <input type="hidden" name="mesa" id="mesa-seleccionada">
                <input type="hidden" name="productos">
                <input type="hidden" name="juego">
                <button type="submit" class="confirm-btn">Confirmar Reserva</button>
                <button type="button" class="btn" onclick="closePopup()">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Pop-up para ayuda -->
    <div class="help-popup" id="helpPopup">
        <div class="help-popup-content">
            <span class="close-btn" onclick="closeHelpPopup()">&times;</span>
            <h2>Gu√≠a de Reserva üóíÔ∏è</h2>
            <ol>
                <li>Selecciona la fecha de tu reserva. üìÜ</li>
                <li>Selecciona la hora de inicio y fin de tu reserva. üï¶</li>
                <li>Haz clic en "Continuar". ‚û°Ô∏è</li>
                <li>Elige una mesa de las disponibles. ü™ë</li>
                <li>Selecciona los productos y juegos que deseas agregar a tu reserva. üçï</li>
                <li>Haz clic en "Confirmar Reserva" para completar el proceso. ‚úÖ</li>
            </ol>
            <h2>Cosas a tomar en cuenta üóíÔ∏è</h2>
            <ol>
            <li>Tomar en cuenta la hora de estad√≠a en restaurante es de 2 horas y med√≠a m√°ximo. üï¶</li>
            <li>Las reservas solo se pueden hacer una vez por fecha. üóìÔ∏è</li>
            <li>Las reservas de juegos solo se puede pedir 1 por reserva. üÉè</li>
            </ol>
        </div>
    </div>

    <script>
        document.getElementById('continuarBtn').addEventListener('click', function() {
            document.getElementById('confirmationPopup').style.display = 'block';
        });

        function closePopup() {
            document.getElementById('confirmationPopup').style.display = 'none';
        }

        document.getElementById('helpBtn').addEventListener('click', function() {
            document.getElementById('helpPopup').style.display = 'block';
        });

        function closeHelpPopup() {
            document.getElementById('helpPopup').style.display = 'none';
        }

        // Script para manejar la selecci√≥n de productos y juegos, as√≠ como la confirmaci√≥n de la reserva
        document.addEventListener('DOMContentLoaded', function() {
            const productosSeleccionadosList = document.querySelector('#productos-seleccionados-table tbody');
            const totalElement = document.getElementById('total');
            const mesaSeleccionadaInput = document.getElementById('mesa-seleccionada');
            const confirmarReservaButton = document.querySelector('#confirmarReservaForm button[type="submit"]');

            function updateTotal() {
                let total = 0;
                productosSeleccionadosList.querySelectorAll('tr').forEach(tr => {
                    total += parseFloat(tr.dataset.total);
                });
                totalElement.innerText = total.toFixed(2);
            }

            function addProducto(id, nombre, precio, cantidad, esJuego = false) {
                const tr = document.createElement('tr');
                tr.dataset.id = id;
                tr.dataset.nombre = nombre;
                tr.dataset.precio = precio;
                tr.dataset.cantidad = cantidad;
                tr.dataset.total = (precio * cantidad).toFixed(2);
                tr.dataset.esJuego = esJuego;
                tr.innerHTML = `
                    <td>${nombre}</td>
                    <td>${precio.toFixed(2)}</td>
                    <td>${cantidad}</td>
                    <td>${(precio * cantidad).toFixed(2)}</td>
                    <td><button type="button" class="eliminar-btn">Eliminar</button></td>
                `;
                productosSeleccionadosList.appendChild(tr);
                updateTotal();
            }

            document.querySelectorAll('.producto-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const id = this.dataset.id;
                    const nombre = this.closest('tr').querySelector('td:nth-child(3)').innerText;
                    const precio = parseFloat(this.dataset.precio);
                    const cantidad = parseInt(this.closest('tr').querySelector('.cantidad-producto').value);
                    if (this.checked) {
                        addProducto(id, nombre, precio, cantidad);
                    } else {
                        productosSeleccionadosList.querySelector(`tr[data-id="${id}"]`).remove();
                        updateTotal();
                    }
                });
            });

            document.querySelectorAll('.cantidad-producto').forEach(input => {
                input.addEventListener('change', function() {
                    const id = this.closest('tr').querySelector('.producto-checkbox').dataset.id;
                    const cantidad = parseInt(this.value);
                    const productoTr = productosSeleccionadosList.querySelector(`tr[data-id="${id}"]`);
                    if (productoTr) {
                        productoTr.dataset.cantidad = cantidad;
                        productoTr.dataset.total = (parseFloat(productoTr.dataset.precio) * cantidad).toFixed(2);
                        productoTr.querySelector('td:nth-child(3)').innerText = cantidad;
                        productoTr.querySelector('td:nth-child(4)').innerText = (parseFloat(productoTr.dataset.precio) * cantidad).toFixed(2);
                        updateTotal();
                    }
                });
            });

            document.querySelectorAll('.juego-radio').forEach(radio => {
                radio.addEventListener('change', function() {
                    productosSeleccionadosList.querySelectorAll('tr[data-es-juego="true"]').forEach(tr => tr.remove());
                    const id = this.dataset.id;
                    const nombre = this.closest('tr').querySelector('td:nth-child(3)').innerText;
                    const precio = parseFloat(this.dataset.precio);
                    addProducto(id, nombre, precio, 1, true);
                });
            });

            productosSeleccionadosList.addEventListener('click', function(e) {
                if (e.target.classList.contains('eliminar-btn')) {
                    e.target.closest('tr').remove();
                    updateTotal();
                }
            });

            document.querySelectorAll('.mesa-radio').forEach(radio => {
                radio.addEventListener('change', function() {
                    mesaSeleccionadaInput.value = this.value;
                    confirmarReservaButton.disabled = false;
                    document.getElementById('mesa-error').style.display = 'none';
                });
            });

            document.querySelector('#confirmarReservaForm').addEventListener('submit', function(e) {
                if (!mesaSeleccionadaInput.value) {
                    e.preventDefault();
                    document.getElementById('mesa-error').style.display = 'block';
                    return;
                }

                const productos = [];
                let juego = '';
                productosSeleccionadosList.querySelectorAll('tr').forEach(tr => {
                    if (tr.dataset.esJuego === 'true') {
                        juego = `${tr.dataset.id}:1`;
                    } else {
                        productos.push(`${tr.dataset.id}:${tr.dataset.cantidad}`);
                    }
                });
                this.querySelector('input[name="productos"]').value = productos.join(',');
                this.querySelector('input[name="juego"]').value = juego;
            });

            // Filtrar productos por categor√≠a
            document.getElementById('categoria_productos').addEventListener('change', function() {
                const categoriaId = this.value;
                document.querySelectorAll('#productos-table tbody tr').forEach(tr => {
                    if (categoriaId === '' || tr.dataset.categoria === categoriaId) {
                        tr.style.display = '';
                    } else {
                        tr.style.display = 'none';
                    }
                });
            });

            // Filtrar juegos por categor√≠a
            document.getElementById('categoria_juegos').addEventListener('change', function() {
                const categoriaId = this.value;
                document.querySelectorAll('#juegos-table tbody tr').forEach(tr => {
                    if (categoriaId === '' || tr.dataset.categoria === categoriaId) {
                        tr.style.display = '';
                    } else {
                        tr.style.display = 'none';
                    }
                });
            });

            // Script para manejar el men√∫ m√≥vil
            document.getElementById('mobile-menu').addEventListener('click', function() {
                document.querySelector('.navbar-right').classList.toggle('active');
            });
        });
    </script>
</body>
</html>
